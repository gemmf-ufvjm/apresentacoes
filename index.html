<!doctype html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Biblioteca de Eventos Científicos</title>
  <meta name="description" content="Coleção de PDFs de eventos científicos com busca, filtros, abas e banners carregados via JSON." />

  <!-- Tailwind: habilita dark mode por classe ANTES do script CDN -->
  <script>
    window.tailwind = window.tailwind || {};
    tailwind.config = { darkMode: 'class' };
  </script>
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Aplica tema salvo cedo (evita flash) -->
  <script>
    (function () {
      try {
        const t = localStorage.getItem('theme');
        if (t === 'dark') document.documentElement.classList.add('dark');
        else if (t === 'light') document.documentElement.classList.remove('dark');
      } catch (e) {}
    })();
  </script>

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root { color-scheme: light dark; }
    html { font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Ubuntu, Cantarell, "Helvetica Neue", Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji", sans-serif; }
    .fade-in { animation: fade-in .25s ease-out; }
    @keyframes fade-in { from { opacity: 0; transform: translateY(4px);} to { opacity: 1; transform: translateY(0);} }
  </style>
</head>
<body class="bg-neutral-50 text-neutral-900 dark:bg-neutral-950 dark:text-neutral-100 min-h-screen">
  <!-- Header -->
  <header class="sticky top-0 z-40 backdrop-blur supports-[backdrop-filter]:bg-white/70 dark:supports-[backdrop-filter]:bg-neutral-900/70 border-b border-neutral-200/70 dark:border-neutral-800/80">
    <div class="max-w-7xl mx-auto px-4 py-4 flex items-center gap-3">
      <button id="btn-menu" class="inline-flex items-center justify-center w-10 h-10 rounded-xl border border-neutral-300/70 dark:border-neutral-700/70 hover:bg-neutral-100 dark:hover:bg-neutral-800" title="Eventos">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5"/></svg>
      </button>
      <div class="flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" class="w-7 h-7 text-indigo-600" viewBox="0 0 24 24" fill="currentColor"><path d="M11 2a1 1 0 0 1 1 1v1.055a8.001 8.001 0 0 1 6.945 6.945H20a1 1 0 1 1 0 2h-1.055A8.001 8.001 0 0 1 12 19.945V21a1 1 0 1 1-2 0v-1.055A8.001 8.001 0 0 1 3.055 13H2a1 1 0 1 1 0-2h1.055A8.001 8.001 0 0 1 10 4.055V3a1 1 0 0 1 1-1Zm0 4a6 6 0 1 0 0 12A6 6 0 0 0 11 6Z"/></svg>
        <div>
          <h1 class="text-xl sm:text-2xl font-semibold tracking-tight">Biblioteca de Eventos Científicos</h1>
          <p class="text-xs text-neutral-500 dark:text-neutral-400">Iniciativa Treelab e GEMMF — UFVJM</p>
        </div>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <div class="relative hidden sm:block">
          <input id="q" type="search" placeholder="Buscar título, autores, evento..." class="w-72 rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 pl-9 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
          <svg class="w-4 h-4 absolute left-3 top-1/2 -translate-y-1/2 text-neutral-400" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="m21 21-5.197-5.197m0 0A7.5 7.5 0 1 0 5.196 5.196a7.5 7.5 0 0 0 10.607 10.607Z"/></svg>
        </div>

        <!-- Toggle dark mode -->
        <button id="btn-theme" class="inline-flex items-center gap-2 rounded-xl border border-neutral-300 dark:border-neutral-700 px-3 py-2 text-sm" title="Alternar tema claro/escuro">
          <span class="inline-block w-4 h-4 rounded-full bg-neutral-900 dark:bg-white"></span>
          Tema
        </button>

        <button id="btn-filtros" class="inline-flex items-center gap-2 rounded-xl bg-indigo-600 text-white px-3 py-2 text-sm hover:bg-indigo-700">
          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 5h18M6 12h12M10 19h4"/></svg>
          Filtros
        </button>
      </div>
    </div>
  </header>

  <!-- Drawer lateral de eventos -->
  <dialog id="dlg-menu" class="p-0 w-full max-w-xs bg-white dark:bg-neutral-900 text-neutral-900 dark:text-neutral-100 border-r border-neutral-200 dark:border-neutral-800 h-full fixed top-0 left-0">
    <form method="dialog" class="h-full flex flex-col">
      <header class="px-4 py-3 border-b border-neutral-200 dark:border-neutral-800 flex items-center justify-between">
        <strong>Eventos</strong>
        <button class="rounded-lg p-2 hover:bg-neutral-100 dark:hover:bg-neutral-800" value="close" aria-label="Fechar">
          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18 18 6M6 6l12 12"/></svg>
        </button>
      </header>
      <div class="p-2 overflow-y-auto" id="eventos-menu"></div>
      <footer class="px-4 py-3 border-t border-neutral-200 dark:border-neutral-800 text-xs text-neutral-500">Clique em um evento para filtrar</footer>
    </form>
  </dialog>

  <main class="max-w-7xl mx-auto px-4 py-6 space-y-6">
    <!-- Abas por Categoria -->
    <nav class="border-b border-neutral-200 dark:border-neutral-800">
      <ul id="tabs" class="flex flex-wrap gap-2">
        <li><button data-categoria="inicio"            class="tab px-3 py-2 rounded-t-lg border-b-2 border-transparent hover:bg-neutral-100 dark:hover:bg-neutral-800">Início</button></li>
        <li><button data-categoria="eventos_internos"  class="tab px-3 py-2 rounded-t-lg border-b-2 border-transparent hover:bg-neutral-100 dark:hover:bg-neutral-800">Eventos Internos</button></li>
        <li><button data-categoria="eventos_externos"  class="tab px-3 py-2 rounded-t-lg border-b-2 border-transparent hover:bg-neutral-100 dark:hover:bg-neutral-800">Eventos Externos</button></li>
        <li><button data-categoria="aulas"             class="tab px-3 py-2 rounded-t-lg border-b-2 border-transparent hover:bg-neutral-100 dark:hover:bg-neutral-800">Aulas</button></li>
        <li><button data-categoria="apresentacoes"     class="tab px-3 py-2 rounded-t-lg border-b-2 border-transparent hover:bg-neutral-100 dark:hover:bg-neutral-800">Apresentações</button></li>
        <li><button data-categoria="3p"                class="tab px-3 py-2 rounded-t-lg border-b-2 border-transparent hover:bg-neutral-100 dark:hover:bg-neutral-800">3P</button></li>
      </ul>
    </nav>

    <!-- Banners -->
    <section>
      <div class="flex items-center justify-between mb-3">
        <h2 class="text-lg font-semibold">Banners</h2>
      </div>

      <!-- Grade -->
      <div id="banners" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

      <!-- Paginação -->
      <div id="paginacao" class="mt-3 flex items-center justify-center gap-2">
        <button id="btn-anterior"
                class="hidden inline-flex items-center gap-2 rounded-xl border border-neutral-300 dark:border-neutral-700 px-4 py-2 text-sm hover:bg-neutral-100 dark:hover:bg-neutral-800">
          Anterior
        </button>
        <button id="btn-mais"
                class="hidden inline-flex items-center gap-2 rounded-xl bg-indigo-600 text-white px-4 py-2 text-sm hover:bg-indigo-700">
          Próxima página
        </button>
      </div>

      <!-- Card -->
      <template id="tpl-banner">
        <article class="group h-full rounded-2xl border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
          <!-- Imagem alta: 3/4 -->
          <div class="aspect-[3/4] overflow-hidden bg-neutral-100 dark:bg-neutral-800 cursor-zoom-in">
            <img class="w-full h-full object-cover group-hover:scale-[1.02] transition-transform banner-img" alt="Prévia do banner"/>
          </div>
          <div class="p-4 space-y-2">
            <h3 class="font-semibold leading-tight line-clamp-2 titulo"></h3>
            <div class="text-sm text-neutral-600 dark:text-neutral-400 autores"></div>
            <p class="text-sm text-neutral-700 dark:text-neutral-300 descricao"></p>
            <div class="flex flex-wrap gap-1 tags"></div>
            <div class="flex flex-wrap gap-2 pt-1">
              <a class="btn-pdf inline-flex items-center justify-center rounded-xl bg-indigo-600 text-white px-3 py-2 text-sm hover:bg-indigo-700" target="_blank" rel="noopener">PDF</a>
              <a class="btn-pptx inline-flex items-center justify-center rounded-xl border border-neutral-300 dark:border-neutral-700 px-3 py-2 text-sm" target="_blank" rel="noopener">PPTX</a>
              <a class="btn-repo inline-flex items-center justify-center rounded-xl border border-neutral-300 dark:border-neutral-700 px-3 py-2 text-sm" target="_blank" rel="noopener">GitHub</a>
              <a class="btn-dados inline-flex items-center justify-center rounded-xl border border-neutral-300 dark:border-neutral-700 px-3 py-2 text-sm" target="_blank" rel="noopener">Dados</a>
              <a class="btn-texto inline-flex items-center justify-center rounded-xl border border-neutral-300 dark:border-neutral-700 px-3 py-2 text-sm" target="_blank" rel="noopener">Texto</a>
            </div>
          </div>
        </article>
      </template>
    </section>

    <!-- Barra de estado -->
    <div class="flex items-center justify-end">
      <div class="flex items-center gap-2">
        <button id="limpar" class="inline-flex items-center justify-center rounded-xl border border-neutral-300 dark:border-neutral-700 px-3 py-2 text-sm">Limpar filtros</button>
      </div>
    </div>

    <!-- (Opcional) Lista de trabalhos de data.json -->
    <section id="lista" class="grid sm:grid-cols-2 lg:grid-cols-3 gap-4"></section>

    <!-- Vazio -->
    <template id="tpl-vazio">
      <div class="col-span-full text-center py-16 border-2 border-dashed rounded-2xl border-neutral-300 dark:border-neutral-700">
        <p class="text-base">Nenhum item encontrado com os filtros atuais.</p>
        <p class="text-sm text-neutral-500 mt-1">Tente remover filtros ou buscar por outras palavras.</p>
      </div>
    </template>

    <!-- Cartão (para data.json, opcional) -->
    <template id="tpl-card">
      <article class="group h-full rounded-2xl border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 overflow-hidden shadow-sm hover:shadow-md transition-shadow">
        <div class="p-4 space-y-2">
          <h3 class="font-semibold leading-tight line-clamp-2 group-hover:underline decoration-2 underline-offset-2"></h3>
          <div class="text-sm text-neutral-600 dark:text-neutral-400 flex flex-wrap gap-x-3 gap-y-1">
            <span class="data"></span>
            <span class="sep">•</span>
            <span class="evento"></span>
          </div>
          <div class="flex flex-wrap gap-1 mt-1 tags"></div>
          <p class="text-sm text-neutral-700 dark:text-neutral-300 line-clamp-3 descricao"></p>
        </div>
        <div class="px-4 pb-4 flex items-center gap-2">
          <a class="abrir inline-flex items-center justify-center rounded-xl bg-indigo-600 text-white px-3 py-2 text-sm hover:bg-indigo-700" target="_blank" rel="noopener">Abrir PDF</a>
          <a class="baixar inline-flex items-center justify-center rounded-xl border border-neutral-300 dark:border-neutral-700 px-3 py-2 text-sm" download>Baixar</a>
          <div class="ml-auto text-xs text-neutral-500"></div>
        </div>
      </article>
    </template>
  </main>

  <!-- Modal Filtros -->
  <dialog id="dlg-filtros" class="rounded-2xl p-0 w-full max-w-xl bg-white dark:bg-neutral-900 text-neutral-900 dark:text-neutral-100 border border-neutral-200 dark:border-neutral-800 shadow-2xl">
    <form method="dialog" class="flex flex-col h-full">
      <header class="px-4 py-3 border-b border-neutral-200 dark:border-neutral-800 flex items-center justify-between">
        <h3 class="font-semibold">Filtros</h3>
        <button class="rounded-lg p-2 hover:bg-neutral-100 dark:hover:bg-neutral-800" value="close" aria-label="Fechar">
          <svg class="w-4 h-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18 18 6M6 6l12 12"/></svg>
        </button>
      </header>
      <div class="p-4 space-y-4 overflow-y-auto">
        <div>
          <label for="q-modal" class="block text-sm font-medium mb-1">Buscar</label>
          <input id="q-modal" type="search" placeholder="título, autores, evento, palavras-chave..." class="w-full rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
        </div>
        <details class="rounded-xl border border-neutral-200 dark:border-neutral-800">
          <summary class="px-3 py-2 cursor-pointer select-none">Mais filtros</summary>
          <div class="p-3 grid sm:grid-cols-2 gap-3">
            <div>
              <label for="evento" class="block text-sm font-medium mb-1">Evento</label>
              <select id="evento" class="w-full rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">Todos</option>
              </select>
            </div>
            <div>
              <label for="tema" class="block text-sm font-medium mb-1">Tema</label>
              <select id="tema" class="w-full rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="">Todos</option>
              </select>
            </div>
            <div>
              <label for="de" class="block text-sm font-medium mb-1">Data (de)</label>
              <input id="de" type="date" class="w-full rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            </div>
            <div>
              <label for="ate" class="block text-sm font-medium mb-1">Data (até)</label>
              <input id="ate" type="date" class="w-full rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500" />
            </div>
            <div class="sm:col-span-2">
              <label for="ordenar" class="block text-sm font-medium mb-1">Ordenar por</label>
              <select id="ordenar" class="w-full rounded-xl border border-neutral-300 dark:border-neutral-700 bg-white dark:bg-neutral-900 px-3 py-2 focus:outline-none focus:ring-2 focus:ring-indigo-500">
                <option value="data_desc">Data (recente → antigo)</option>
                <option value="data_asc">Data (antigo → recente)</option>
                <option value="titulo_asc">Título (A–Z)</option>
                <option value="titulo_desc">Título (Z–A)</option>
              </select>
            </div>
          </div>
        </details>
      </div>
      <footer class="px-4 py-3 border-t border-neutral-200 dark:border-neutral-800 flex items-center justify-between">
        <button id="btn-limpar-modal" class="rounded-xl border border-neutral-300 dark:border-neutral-700 px-3 py-2 text-sm">Limpar</button>
        <button class="rounded-xl bg-indigo-600 text-white px-3 py-2 text-sm" value="close">Fechar</button>
      </footer>
    </form>
  </dialog>

  <!-- Lightbox da imagem -->
  <dialog id="dlg-img" class="rounded-xl p-0 w-full max-w-5xl bg-transparent backdrop:bg-black/70">
    <div class="relative">
      <img id="img-full" class="w-full h-auto rounded-xl" alt="Visualização do banner" />
      <form method="dialog">
        <button class="absolute top-2 right-2 rounded-lg bg-white/90 dark:bg-neutral-900/90 p-2" aria-label="Fechar">
          <svg class="w-5 h-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M6 18 18 6M6 6l12 12"/></svg>
        </button>
      </form>
    </div>
  </dialog>

  <footer class="max-w-7xl mx-auto px-4 pb-12 text-xs text-neutral-500 dark:text-neutral-400">
    <hr class="border-neutral-200 dark:border-neutral-800 mb-4" />
    <p>Iniciativa Treelab e GEMMF — UFVJM</p>
  </footer>

  <script>
    // ========= Config =========
    const DATA_JSON_URL = 'data.json';
    // Procura o manifesto em uma dessas pastas:
    const BANNERS_DIR_CANDIDATES = ['json/banners/', 'banners/json/banners/'];
    const BANNERS_INDEX_FILE = 'index.json';

    // ========= Utils =========
    const $ = (s, el=document) => el.querySelector(s);
    const $$ = (s, el=document) => [...el.querySelectorAll(s)];
    const genId = () => (crypto.randomUUID ? crypto.randomUUID() : ('id-' + Date.now().toString(36) + Math.random().toString(36).slice(2, 8)));
    const debounce = (fn, ms=120) => { let t; return (...a)=>{ clearTimeout(t); t=setTimeout(()=>fn(...a), ms); }; };
    function uniq(arr){ return [...new Set(arr.filter(Boolean))]; }

    function isLikelyJSONResponse(resp){
      const ct = resp.headers.get('content-type') || '';
      return ct.includes('application/json') || ct.includes('text/json');
    }
    async function baixarJSON(url){
      const bust = (url.includes('?') ? '&' : '?') + 't=' + Date.now();
      const r = await fetch(url + bust, { cache: 'no-store' });
      if (!r.ok) throw new Error('HTTP ' + r.status + ' em ' + url);
      if (!isLikelyJSONResponse(r)) {
        const txt = await r.text();
        throw new Error('Conteúdo não é JSON em ' + url + ' (inicio: ' + txt.slice(0,60).replace(/\s+/g,' ') + '...)');
      }
      return r.json();
    }
    function formatarData(yyyyMMdd){ if(!yyyyMMdd) return ''; const d=new Date(yyyyMMdd); return isNaN(d)? yyyyMMdd : d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'2-digit'}); }

    // ========= Normalização =========
    function normalizarItem(x){ return {
      id: x.id || genId(),
      titulo: x.titulo || 'Sem título',
      autores: x.autores || '',
      evento: x.evento || '',
      tema: Array.isArray(x.tema) ? x.tema : (x.tema ? [x.tema] : []),
      palavrasChave: x.palavrasChave || [],
      data: x.data || '',
      descricao: x.descricao || '',
      arquivo: x.arquivo, tamanhoBytes: x.tamanhoBytes
    };}

    function normalizarBanner(b){ return {
      id: b.id || genId(),
      titulo: b.titulo || 'Banner',
      autores: b.autores || '',
      img: b.img || '',
      pdf: b.pdf || '',
      pptx: b.pptx || '',
      evento: b.evento || '',
      tema: Array.isArray(b.tema) ? b.tema : (b.tema ? [b.tema] : []),
      data: b.data || '',
      descricao: b.descricao || '',
      // NOVO: PDF com texto/metodologia
      texto: b.texto || b.textoPdf || '',
      repo: b.repo || b.github || '',
      dados: b.dados || b.dataUrl || '',
      // NOVO: categoria para filtrar por abas
      categoria: (b.categoria || 'inicio').toString().toLowerCase()
    };}

    function coerceBannersFromPayload(p){
      if (Array.isArray(p)) return p.map(normalizarBanner);
      if (p && typeof p === 'object') return [normalizarBanner(p)];
      return [];
    }

    // ========= Resolver diretório + carregar =========
    async function resolverDiretorioDeBanners(){
      for (const base of BANNERS_DIR_CANDIDATES){
        try { await baixarJSON(base + BANNERS_INDEX_FILE); return base; } catch {}
      }
      throw new Error('Nenhum index.json encontrado em: ' + BANNERS_DIR_CANDIDATES.join(', '));
    }
    async function carregarBannersDoManifest(){
      const base = await resolverDiretorioDeBanners();
      const idx = await baixarJSON(base + BANNERS_INDEX_FILE);
      let names = [];
      if (Array.isArray(idx)){
        if (typeof idx[0] === 'string') names = idx;
        else if (typeof idx[0] === 'object') names = idx.map(x => x.file || x.name || x.path).filter(Boolean);
      }
      const lists = await Promise.all(names.map(async (name)=>{
        try { return coerceBannersFromPayload(await baixarJSON(base + String(name).replace(/^\/*/,''))); }
        catch(e){ console.warn('JSON inválido:', name, e.message); return []; }
      }));
      return lists.flat().filter(Boolean);
    }

    // ========= Estado =========
    const state = {
      q:'', evento:'', tema:'', de:'', ate:'', ordenar:'data_desc',
      page:1,                 // pagina atual (paginacao progressiva)
      categoria:'inicio',     // aba ativa
    };

    // ========= Filtros & Ordenação =========
    function passaFiltro(i){
      // filtro por categoria (abas)
      if (state.categoria && state.categoria !== 'inicio'){
        if ((i.categoria || 'inicio') !== state.categoria) return false;
      }
      // busca livre
      const termo = state.q.trim().toLowerCase();
      if (termo){
        const campo = [i.titulo, i.autores, i.evento, i.descricao, ...(i.tema||[])].join(' ').toLowerCase();
        if (!campo.includes(termo)) return false;
      }
      // selects
      if (state.evento && i.evento !== state.evento) return false;
      if (state.tema && !(i.tema||[]).includes(state.tema)) return false;
      if (state.de && (!i.data || i.data < state.de)) return false;
      if (state.ate && (!i.data || i.data > state.ate)) return false;
      return true;
    }
    function aplicarOrdenacao(arr, ordem){
      const a = [...arr];
      switch(ordem){
        case 'data_asc':   return a.sort((x,y)=> (x.data||'').localeCompare(y.data||''));
        case 'titulo_asc': return a.sort((x,y)=> x.titulo.localeCompare(y.titulo, undefined, {sensitivity:'base'}));
        case 'titulo_desc':return a.sort((x,y)=> y.titulo.localeCompare(x.titulo, undefined, {sensitivity:'base'}));
        case 'data_desc':
        default:           return a.sort((x,y)=> (y.data||'').localeCompare(x.data||''));
      }
    }

    // ========= Paginação por 4 linhas =========
    function getGridCols(){
      const el = document.getElementById('banners');
      if (!el) return 1;
      const cs = getComputedStyle(el);
      const cols = cs.gridTemplateColumns?.split(' ').filter(Boolean).length || 1;
      return Math.max(1, cols);
    }
    function getPageSize(){ return 4 * getGridCols(); } // 4 linhas * n colunas

    // ========= Dados =========
    let ITENS = [];   // opcional (data.json)
    let BANNERS = []; // banners

    // ========= Render =========
    function preencherSelectsBanners(banners){
      const eventos = uniq(banners.map(b=>b.evento).filter(Boolean)).sort((a,b)=>a.localeCompare(b));
      const temas = uniq(banners.flatMap(b=>b.tema).filter(Boolean)).sort((a,b)=>a.localeCompare(b));
      const selEvento = $('#evento'), selTema = $('#tema');
      if (selEvento){ selEvento.length = 1; for (const e of eventos) selEvento.add(new Option(e,e)); if (state.evento) selEvento.value=state.evento; }
      if (selTema){ selTema.length = 1; for (const t of temas) selTema.add(new Option(t,t)); if (state.tema) selTema.value=state.tema; }
    }
    function buildMenuEventos(banners){
      const cont = $('#eventos-menu'); if (!cont) return;
      cont.innerHTML = '';
      const addBtn = (label, val) => {
        const btn = document.createElement('button');
        btn.type = 'button';
        btn.className = 'w-full text-left px-3 py-2 rounded-lg hover:bg-neutral-100 dark:hover:bg-neutral-800';
        btn.textContent = label;
        btn.addEventListener('click', ()=>{
          state.evento = val;
          const sel=$('#evento'); if (sel) sel.value=val;
          state.page=1; renderBanners(); $('#dlg-menu').close();
        });
        cont.append(btn);
      };
      addBtn('Todos os eventos','');
      for (const e of uniq(banners.map(b=>b.evento).filter(Boolean)).sort((a,b)=>a.localeCompare(b))) addBtn(e, e);
    }

    function renderBanners(){
      const cont = $('#banners'); cont.innerHTML = '';
      const tpl = $('#tpl-banner');

      // filtro + ordenação
      const todos = aplicarOrdenacao(BANNERS.filter(passaFiltro), state.ordenar);

      // paginação progressiva
      const pageSize = getPageSize();
      const end = Math.min(todos.length, state.page * pageSize);
      const exibidos = todos.slice(0, end);

      // cards
      for (const b of exibidos){
        const el = tpl.content.cloneNode(true);
        const imgEl = $('.banner-img', el);
        imgEl.src = b.img; imgEl.alt = `Prévia do banner: ${b.titulo}`;
        imgEl.addEventListener('click', ()=> abrirImagem(b.img));
        imgEl.addEventListener('error', ()=>{
          imgEl.src='data:image/svg+xml,"<svg xmlns=\'http://www.w3.org/2000/svg\' width=\'800\' height=\'450\'><rect width=\'100%\' height=\'100%\' fill=\'#eee\'/><text x=\'50%\' y=\'50%\' dominant-baseline=\'middle\' text-anchor=\'middle\' fill=\'#999\' font-family=\'sans-serif\' font-size=\'20\'>imagem indisponível</text></svg>"';
        });

        $('.titulo', el).textContent = b.titulo;
        $('.autores', el).textContent = b.autores || '';
        $('.descricao', el).textContent = b.descricao || '';

        const tags = $('.tags', el);
        if (b.evento){ const t=document.createElement('span'); t.className='text-xs px-2 py-0.5 rounded-full bg-neutral-200/70 dark:bg-neutral-800'; t.textContent=b.evento; tags.append(t); }
        if (b.data){ const t=document.createElement('span'); t.className='text-xs px-2 py-0.5 rounded-full bg-neutral-200/70 dark:bg-neutral-800'; t.textContent=b.data; tags.append(t); }
        for (const tm of b.tema||[]){ const t=document.createElement('span'); t.className='text-xs px-2 py-0.5 rounded-full bg-neutral-200/70 dark:bg-neutral-800'; t.textContent=tm; tags.append(t); }
        if (b.categoria){ const t=document.createElement('span'); t.className='text-xs px-2 py-0.5 rounded-full bg-indigo-100 text-indigo-800 dark:bg-indigo-900/40 dark:text-indigo-200'; t.textContent=b.categoria; tags.append(t); }

        const btnPdf   = $('.btn-pdf', el);
        const btnPptx  = $('.btn-pptx', el);
        const btnRepo  = $('.btn-repo', el);
        const btnDados = $('.btn-dados', el);
        const btnTexto = $('.btn-texto', el);
        if (b.pdf)   btnPdf.href = b.pdf;   else btnPdf.classList.add('opacity-50','pointer-events-none');
        if (b.pptx)  btnPptx.href = b.pptx; else btnPptx.classList.add('opacity-50','pointer-events-none');
        if (b.repo)  btnRepo.href = b.repo; else btnRepo.classList.add('opacity-50','pointer-events-none');
        if (b.dados) btnDados.href = b.dados; else btnDados.classList.add('opacity-50','pointer-events-none');
        if (b.texto) btnTexto.href = b.texto; else btnTexto.classList.add('opacity-50','pointer-events-none');

        cont.append(el);
      }

      // paginação: mostrar/ocultar botões
      const btnMais = $('#btn-mais');
      const btnAnt  = $('#btn-anterior');
      if (btnMais){
        if (end < todos.length) {
          btnMais.classList.remove('hidden');
          btnMais.onclick = ()=>{ state.page += 1; renderBanners(); };
        } else { btnMais.classList.add('hidden'); btnMais.onclick = null; }
      }
      if (btnAnt){
        if (state.page > 1) {
          btnAnt.classList.remove('hidden');
          btnAnt.onclick = ()=>{ state.page = Math.max(1, state.page - 1); renderBanners(); };
        } else { btnAnt.classList.add('hidden'); btnAnt.onclick = null; }
      }
    }

    function renderLista(){
      const lista = $('#lista'); lista.innerHTML = '';
      if (!ITENS.length) return;
      const filtrados = aplicarOrdenacao(ITENS.filter(passaFiltro), state.ordenar);
      if (!filtrados.length) { lista.append($('#tpl-vazio').content.cloneNode(true)); return; }
      const tpl = $('#tpl-card');
      for (const it of filtrados){
        const card = tpl.content.cloneNode(true);
        $('h3', card).textContent = it.titulo;
        $('.data', card).textContent = formatarData(it.data);
        $('.evento', card).textContent = it.evento || '—';
        const tags = $('.tags', card);
        for (const t of it.tema || []) {
          const s=document.createElement('span'); s.className='text-xs px-2 py-0.5 rounded-full bg-neutral-200/70 dark:bg-neutral-800'; s.textContent=t; tags.append(s);
        }
        $('.descricao', card).textContent = it.descricao || '';
        const abrir = $('.abrir', card); abrir.href = it.arquivo || '#';
        const baixar = $('.baixar', card);
        if (it.arquivo) { baixar.href = it.arquivo; baixar.download = ''; }
        else { baixar.classList.add('opacity-50','pointer-events-none'); }
        lista.append(card);
      }
    }

    function abrirImagem(src){ const dlg = $('#dlg-img'); $('#img-full').src = src; dlg.showModal(); }

    // ========= UI =========
    function conectarUI(){
      // tema
      $('#btn-theme').addEventListener('click', ()=>{
        const isDark = document.documentElement.classList.toggle('dark');
        localStorage.setItem('theme', isDark ? 'dark' : 'light');
      });

      // busca
      const qHeader = $('#q');
      if (qHeader){ qHeader.value = state.q; qHeader.addEventListener('input', e => { state.q = e.target.value; state.page=1; renderBanners(); }); }

      // filtros modal
      const dlg = $('#dlg-filtros');
      $('#btn-filtros').addEventListener('click', ()=> dlg.showModal());
      $('#btn-menu').addEventListener('click', ()=> $('#dlg-menu').showModal());
      const qModal = $('#q-modal'); if(qModal){ qModal.value = state.q; qModal.addEventListener('input', e=>{ state.q = e.target.value; if (qHeader) qHeader.value = state.q; state.page=1; renderBanners(); }); }
      $('#evento').addEventListener('change', e=>{ state.evento = e.target.value; state.page=1; renderBanners(); });
      $('#tema').addEventListener('change', e=>{ state.tema = e.target.value; state.page=1; renderBanners(); });
      $('#de').addEventListener('change', e=>{ state.de = e.target.value; state.page=1; renderBanners(); });
      $('#ate').addEventListener('change', e=>{ state.ate = e.target.value; state.page=1; renderBanners(); });
      $('#ordenar').addEventListener('change', e=>{ state.ordenar = e.target.value; state.page=1; renderBanners(); });
      $('#btn-limpar-modal').addEventListener('click', (ev)=>{ ev.preventDefault(); limparFiltros(); });

      // abas
      $$('#tabs .tab').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          $$('#tabs .tab').forEach(b=>b.classList.remove('border-indigo-600','text-indigo-600','bg-indigo-50','dark:bg-indigo-900/30'));
          btn.classList.add('border-indigo-600','text-indigo-600','bg-indigo-50','dark:bg-indigo-900/30');
          state.categoria = btn.dataset.categoria || 'inicio';
          state.page = 1;
          renderBanners();
        });
      });
      // seleciona aba Início por padrão
      const firstTab = $('#tabs .tab'); if (firstTab) firstTab.click();

      // limpar
      const btnLimpar = $('#limpar'); if (btnLimpar) btnLimpar.addEventListener('click', limparFiltros);

      // re-render quando cols mudarem (impacta paginação por 4 linhas)
      window.addEventListener('resize', debounce(()=>{ renderBanners(); }, 150));
    }

    function limparFiltros(){
      Object.assign(state, { q:'', evento:'', tema:'', de:'', ate:'', ordenar:'data_desc', page:1 });
      const qHeader = $('#q'); if (qHeader) qHeader.value = '';
      const qm = $('#q-modal'); if (qm) qm.value = '';
      $('#evento').value = ''; $('#tema').value = ''; $('#de').value = ''; $('#ate').value = ''; $('#ordenar').value = 'data_desc';
      renderBanners(); renderLista();
    }

    // ========= Boot =========
    let BANNERS = [];
    let ITENS = [];

    async function iniciar(){
      conectarUI();

      try {
        const data = await baixarJSON(DATA_JSON_URL);
        if (Array.isArray(data)) ITENS = data.map(normalizarItem);
        else if (data && typeof data === 'object') ITENS = (data.itens || data.items || []).map(normalizarItem);
      } catch(e){ ITENS = []; }

      try {
        BANNERS = await carregarBannersDoManifest();
      } catch(e){ console.warn(e.message); BANNERS = []; }

      preencherSelectsBanners(BANNERS);
      buildMenuEventos(BANNERS);
      renderBanners();
      renderLista();
    }
    iniciar();
  </script>
</body>
</html>
